{% load static %}
<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <!-- 設定字符集 -->
    <meta charset="UTF-8">
    
    <!-- 頁面標題 -->
    <title>ChatSchool</title>

    <!-- 引入樣式表 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <link rel="stylesheet" href="{% static 'css/authentication.css' %}">
    <link rel="stylesheet" href="{% static 'css/sidebar.css' %}">
    <link rel="stylesheet" href="{% static 'css/chat.css' %}">
    <link rel="stylesheet" href="{% static 'css/chatLinks.css' %}">
    <link rel="stylesheet" href="{% static 'css/chatHistory.css' %}">
    <link rel="stylesheet" href="{% static 'css/chatModelSelector.css' %}">
    <link rel="stylesheet" href="{% static 'css/feedback.css' %}">
    <link rel="stylesheet" href="{% static 'css/calendar.css' %}">

    <!-- 引入 marked.js 解析 Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- 引入 MathJax 支援 LaTeX -->
    <script>
        window.MathJax = {
            tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] },
            svg: { fontCache: 'global' }
        };
    <!--響應式設計-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" async></script>
</head>
<body>    
    <div id="cursor-light"></div>
    <div class="menu-icon">
        <div></div>
        <div></div>
        <div></div>
    </div>
    <div class="main-content-m">
    <div class="chat-box" id="messages">
        {% if selected_chat %}
            {% if messages %}
                {% for msg in messages %}
                    <div class="message-container {% if msg.username == 'bot' %}bot-message-container{% else %}user-message-container{% endif %}">
                        {% if msg.username == 'bot' %}
                            <div class="message-header">
                                <div class="model-name-box">
                                    <div class="model-name-text">
                                        {% if msg.model_name == "rag" %}
                                            一般檢索
                                        {% elif msg.model_name == "cag" %}
                                            快速檢索
                                        {% elif msg.model_name == "rag_key" %}
                                            關鍵詞檢索
                                        {% elif msg.model_name == "kgrag" %}
                                            關鍵字擴充檢索
                                        {% elif msg.model_name == "graphrag" %}
                                            廣度檢索
                                        {% elif msg.model_name == "sturag" %}
                                            資料結構化檢索
                                        {% elif msg.model_name == "direct" %}
                                            一般回應
                                        {% else %}
                                            AI Model
                                        {% endif %}
                                    </div>
                                </div>
                                {% if msg.related_links %}
                                    <div class="related-links-wrapper">
                                        <button class="related-links-icon-btn" title="來源連結" onclick="toggleFloatingLinks(this)">
                                            <i class="bi bi-link-45deg"></i>
                                        </button>
                                        <div class="floating-links-container">
                                            <div class="links-list">
                                                {% for link in msg.related_links %}
                                                    <a href="{{ link.url }}" target="_blank" class="related-link-item">
                                                        {{ link.title }}
                                                    </a>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                {% endif %}
                            </div>

                            <div class="message bot-message">
                                {{ msg.rendered|safe }}
                            </div>

                            {% if msg.image_links %}
                                <div class="image-gallery">
                                    {% for link in msg.image_links %}
                                        <a href="#" onclick="event.preventDefault(); openImageModal('{{ link }}')">
                                            <img src="{{ link }}" alt="來源圖片">
                                        </a>
                                    {% endfor %}
                                </div>
                            {% endif %}

                            {% if msg.duration %}
                                <div class="message-duration">
                                    （耗時：{{ msg.duration|floatformat:2 }}秒）
                                </div>
                            {% endif %}
                        {% else %}
                            <div class="message user-message">
                                {{ msg.content|safe }}
                            </div>
                        {% endif %}
                    </div>
                {% endfor %}
            {% else %}
                <!-- 有選擇聊天但目前沒有訊息 -->
                <div class="empty-chat-placeholder">
                    <img src="{% static 'images/chatschool.png' %}" alt="開始新的對話" class="empty-chat-image">
                </div>
            {% endif %}
        {% else %}
            <!-- 沒有選擇聊天時顯示圖片 -->
            <div class="empty-chat-placeholder">
                <img src="{% static 'images/chatschool.png' %}" alt="開始新的對話" class="empty-chat-image">
            </div>
        {% endif %}
    </div>
        <div class="input-area-m">
            <!-- 模型選擇區 -->
            <div class="model-selector-wrapper">
                <button class="model-toggle-btn" onclick="toggleModelMenu()">＋</button>
                <div class="model-popup-menu" id="model-popup-menu">
                    <label><input type="radio" name="model" value="auto" checked> 自動模式</label>
                    <label><input type="radio" name="model" value="rag"> 一般檢索</label>
                    <label><input type="radio" name="model" value="cag"> 快速檢索</label>
                    <label><input type="radio" name="model" value="sturag"> 資料結構化檢索</label>
                    <label><input type="radio" name="model" value="rag_key"> 關鍵詞檢索</label>
                    <label><input type="radio" name="model" value="kgrag"> 關鍵詞擴充檢索</label>
                    <label><input type="radio" name="model" value="graphrag"> 廣度檢索</label>
                </div>
            </div>
            <div class="input-container-m">
                <textarea id="message" placeholder="{{ random_question }}" rows="1"></textarea>
                <!-- 語音輸入按鈕 -->
                <button id="voice-btn" class="voice-btn" type="button" title="語音輸入" aria-pressed="false">
                    <i class="bi bi-mic"></i>
                </button>
                <!-- 原送出按鈕 -->
                <button id="send-btn" type="button" onclick="sendMessage()" title="送出">↑</button>
            </div>
        </div>        
    </div>
    <div id="hamburger-menu" onclick="toggleMenu()">
        <div class="hamburger-line"></div>
        <div class="hamburger-line"></div>
        <div class="hamburger-line"></div>
    </div>

    {% if not user.is_authenticated %}
        <div id="login-banner" class="floating-banner">〔登入 / 註冊〕</div>
        <div id="login-banner-2" class="floating-banner-2">需要登入才能使用全部功能</div>
    {% endif %}

    <div id="login-modal" class="modal-overlay">
        <div class="modal-content-login">
            <span class="close-btn" onclick="closeLoginModal()">&times;</span>
            <h2>登入 / 註冊</h2>
            <form id="login-form">
                <label for="email">Gmail：</label>
                <input type="email" id="email" name="email" placeholder="example@gmail.com" required>

                <label for="username">名稱：</label>
                <input type="text" id="username" name="username" placeholder="Your name">

                <label for="password">密碼：</label>
                <input type="password" id="password" name="password" required>

                <label for="verification_code">驗證碼：</label>
                <div class="code-container">
                    <input type="text" id="verification_code" name="verification_code" required>
                        <button type="button" id="send-code-btn" title="發送驗證碼">
                                <i class="bi bi-envelope"></i>
                    </button>
                </div>
                <button type="submit">登入</button>
            </form>
        </div>
    </div>
    <div id="sidebar" class="sidebar {% if not user.is_authenticated %}blurred{% endif %}">
        <div class="sidebar-icons">
            <button class="icon-btn" onclick="goToSettings()" title="設定"><i class="bi bi-gear"></i></button>            
            <button class="icon-btn" onclick="goToCalendar()" title="行事曆"><i class="bi bi-calendar-event"></i></button> 
            <button class="icon-btn" data-bs-toggle="modal" data-bs-target="#feedbackModal" title="意見回饋">
                <i class="bi bi-chat-dots"></i></button>  
            <button class="icon-btn" onclick="goToGuide()" title="教學指南"><i class="bi bi-question-circle"></i></button>
        </div>
        <div>
            <div class="chat-history-header">
                <h4 class="chat-history-title">Chat History</h4>
                <button class="add-chat-btn" onclick="createNewChatHistory()">+</button>
            </div>            
            <div class="chat-history">
                {% for chat in chat_history %}
                    <div class="chat-entry">
                        <a href="?chat_history_id={{ chat.id }}" data-chat-id="{{ chat.id }}" onclick="loadChatHistory({{ chat.id }})">
                            {{ chat.title }}
                        </a>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div> 

    <div id="image-modal" class="image-modal-overlay" onclick="closeImageModal()">
        <span class="image-modal-close">&times;</span>
        <img class="image-modal-content" id="image-modal-img">
    </div>
    <!-- 回饋意見 Modal -->
    <div class="modal fade" id="feedbackModal" tabindex="-1" aria-labelledby="feedbackModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-custom-xl">
            <div class="modal-content p-3">
            <div class="modal-header">
                <h5 class="modal-title" id="feedbackModalLabel">回饋意見</h5>
                </div>
            <div class="modal-body">
                <textarea id="feedback-content" placeholder="請輸入您的建議或回饋..." style="width:100%; height:120px; resize:none; padding:10px; border-radius:6px; border:1px solid #ccc;"></textarea>
                <p id="feedback-response" style="margin-top:10px; text-align:center;"></p>
            </div>
            </div>
            <div class="modal-actions-outside" id="feedbackModalActions" aria-hidden="true"></div>
        </div>
    </div>   
    
    <script>
    window.csrfToken = '{{ csrf_token }}';
    window.userEmail = "{{ user_email|escapejs }}";
    window.settingsUrl = "{% url 'settings' %}";
    window.calendarUrl = "{% url 'calendar' %}";
    window.submitFeedbackUrl = "{% url 'submit_feedback' %}";
    window.guideUrl = "{% url 'guide' %}";
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{% static 'js/chat.js' %}"></script>  
    </body>
</html>
