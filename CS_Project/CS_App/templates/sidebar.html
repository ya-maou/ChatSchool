{% load static %}
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>{% block title %}ChatSchool{% endblock %}</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/chat.css' %}">
    <link rel="stylesheet" href="{% static 'css/sidebar.css' %}">
    <link rel="stylesheet" href="{% static 'css/authentication.css' %}">
    <link rel="stylesheet" href="{% static 'css/feedback.css' %}">
    <link rel="stylesheet" href="{% static 'css/chatHistory.css' %}">
    {% block extra_css %}{% endblock %}
</head>
<body>
    <div id="cursor-light"></div>
    <div class="menu-icon">
        <div></div>
        <div></div>
        <div></div>
    </div>

    <div id="hamburger-menu" onclick="toggleMenu()">
        <div class="hamburger-line"></div>
        <div class="hamburger-line"></div>
        <div class="hamburger-line"></div>
    </div>

    {% if not user.is_authenticated %}
        <div id="login-banner" class="floating-banner">〔登入 / 註冊〕</div>
        <div id="login-banner-2" class="floating-banner-2">需要登入才能使用全部功能</div>
    {% endif %}

    <div id="login-modal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-btn" onclick="closeLoginModal()">&times;</span>
            <h2>登入 / 註冊</h2>
            <form id="login-form">
                <label for="email">Gmail：</label>
                <input type="email" id="email" name="email" placeholder="example@gmail.com" required>
                <label for="password">密碼：</label>
                <input type="password" id="password" name="password" required>
                <button type="submit">登入</button>
            </form>
        </div>
    </div>
    <div id="sidebar" class="sidebar {% if not user.is_authenticated %}blurred{% endif %}">
        <div class="sidebar-icons">
            {% if request.path == '/settings/' %}
                <button class="icon-btn" onclick="goToHome()" title="回到主頁"><i class="bi bi-house-door"></i></button>
            {% else %}
                <button class="icon-btn" onclick="goToSettings()" title="設定"><i class="bi bi-gear"></i></button>
            {% endif %}

            {% if request.path == '/calendar/' %}
                <button class="icon-btn" onclick="goToHome()" title="回到主頁"><i class="bi bi-house-door"></i></button>
            {% else %}
                <button class="icon-btn" onclick="goToCalendar()" title="行事曆"><i class="bi bi-calendar-event"></i></button>
            {% endif %}

            <button class="icon-btn" data-bs-toggle="modal" data-bs-target="#feedbackModal" title="意見回饋">
                <i class="bi bi-chat-dots"></i></button>
                
            {% if request.path == '/guide/' %}
                <button class="icon-btn" onclick="goToHome()" title="回到主頁"><i class="bi bi-house-door"></i></button>
            {% else %}
                <button class="icon-btn" onclick="goToGuide()" title="教學指南"><i class="bi bi-question-circle"></i></button>
            {% endif %}
        </div>
        <div>
            {% if request.path == '/calendar/' %}
                <div class="chat-history-header">
                    <h4 class="chat-history-title">Main Pin</h4>
                </div>
                <div class="chat-history" id="main-event-list">
                    <!-- JS 動態插入 -->
                </div>
            {% elif request.path == '/guide/' %}
                <div class="chat-history-header">
                    <h4 class="chat-history-title">Catalog</h4>
                </div>
                <div class="chat-history" id="guide-catalog">
                    <div class="chat-entry"><a href="#chat-interface">登入系統</a></div>
                    <div class="chat-entry"><a href="#calendar-module">主畫面介紹</a></div>
                    <div class="chat-entry"><a href="#main-pin">設定介紹</a></div>
                    <div class="chat-entry"><a href="#auth">行事曆介紹</a></div>
                    <div class="chat-entry"><a href="#feedback">意見回饋</a></div>
                </div>
            {% elif request.path == '/settings/' %}
                <div class="chat-history-header">
                    <h4 class="chat-history-title">Settings</h4>
                </div>
            {% else %}
            <div class="chat-history-header">
                <h4 class="chat-history-title">Chat History</h4>
                <button class="add-chat-btn" onclick="createNewChatHistory()">+</button>
            </div>
            <div class="chat-history">
                {% for chat in chat_history %}
                    <div class="chat-entry">
                        <a href="?chat_history_id={{ chat.id }}" data-chat-id="{{ chat.id }}" onclick="loadChatHistory({{ chat.id }})">
                            {{ chat.title }}
                        </a>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
        </div>
    </div>
    <div class="main-content">
        {% block content %}{% endblock %}
    </div>
    <!-- 回饋意見 Modal -->
    <div class="modal fade" id="feedbackModal" tabindex="-1" aria-labelledby="feedbackModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-custom-xl">
            <div class="modal-content p-3">
            <div class="modal-header">
                <h5 class="modal-title" id="feedbackModalLabel">回饋意見</h5>
                </div>
            <div class="modal-body">
                <textarea id="feedback-content" placeholder="請輸入您的建議或回饋..." style="width:100%; height:120px; resize:none; padding:10px; border-radius:6px; border:1px solid #ccc;"></textarea>
                <p id="feedback-response" style="margin-top:10px; text-align:center;"></p>
            </div>
            </div>
            <div class="modal-actions-outside" id="feedbackModalActions" aria-hidden="true"></div>
        </div>
    </div>
    <!--我新增的區塊：用來插入 modal（放在 main-content 外層） -->
    {% block modals %}{% endblock %}
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const csrfToken = '{{ csrf_token }}';
        let currentChatId = null;

        document.addEventListener("DOMContentLoaded", () => {
            const params = new URLSearchParams(window.location.search);
            if (params.has('chat_history_id')) {
                currentChatId = params.get('chat_history_id');
                console.log("已選擇歷史對話，ID =", currentChatId);
            }
            refreshChatHistorySidebar();
        });

        document.getElementById('login-banner')?.addEventListener('click', () => {
            document.getElementById('login-modal').style.display = 'block';
        });
        document.getElementById('login-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value.trim();
            fetch('/login_api/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                body: JSON.stringify({ email, password })
            })
            .then(res => res.json())
            .then(data => {
                alert(data.message);
                if (data.success) location.reload();
            })
            .catch(() => alert('登入時發生錯誤'));
        });
        function closeLoginModal() {
            document.getElementById('login-modal').style.display = 'none';
        }
        window.addEventListener('click', e => {
            const modal = document.getElementById('login-modal');
            if (e.target === modal) modal.style.display = 'none';
        });

        function goToSettings() { window.location.href = "{% url 'settings' %}"; }
        function goToCalendar() { window.location.href = "{% url 'calendar' %}"; }
        function goToGuide() { window.location.href = "{% url 'guide' %}"; }
        function goToHome() {
            window.location.href = "{% url 'chat' %}";
        }

        function toggleMenu() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.querySelector('.main-content');
            const loginBanner = document.getElementById('login-banner');
            const loginBanner2 = document.getElementById('login-banner-2');

            sidebar.classList.toggle('show');

            if (sidebar.classList.contains('show')) {
                mainContent.style.transform = 'translateX(280px)';
                mainContent.style.width = 'calc(100% - 280px)';
                if (loginBanner) {
                    loginBanner.style.left = '68px';
                    loginBanner2.style.left = '37px';
                }
            } else {
                mainContent.style.transform = 'translateX(0)';
                mainContent.style.width = '100%';
                if (loginBanner) {
                    loginBanner.style.left = '-250px';
                    loginBanner2.style.left = '-400px';
                }
            }
        }

        const light = document.getElementById('cursor-light');
        document.addEventListener('mousemove', e => {
            light.style.left = e.clientX + 'px';
            light.style.top = e.clientY + 'px';
        });

        console.log("目前登入帳號：", "{{ user.email|default:'未登入'|escapejs }}");
        
        function submitFeedback() {
            const content = document.getElementById("feedback-content").value.trim();
            const responseEl = document.getElementById("feedback-response");
            
            if (!content) {
                responseEl.textContent = "請填寫回饋內容！";
                responseEl.style.color = "orange";
                return;
            }

            fetch("{% url 'submit_feedback' %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": getCookie('csrftoken')
                },
                body: JSON.stringify({ content: content })
            })
            .then(res => res.json())
            .then(data => {
                responseEl.textContent = data.message;
                responseEl.style.color = data.success ? "green" : "red";
                if (data.success) {
                    document.getElementById("feedback-content").value = "";
                }
            })
            .catch(err => {
                responseEl.textContent = "提交失敗：" + err;
                responseEl.style.color = "red";
            });
        }

        // 在 feedbackModal 顯示時，動態建立並綁定按鈕
        const feedbackModalEl = document.getElementById('feedbackModal');
        feedbackModalEl.addEventListener('show.bs.modal', function () {
            const actionsContainer = document.getElementById('feedbackModalActions');

            // 動態建立所有外部按鈕
            actionsContainer.innerHTML = `
                <button type="button" class="modal-action-btn modal-close-outside" title="關閉" aria-label="關閉" data-bs-dismiss="modal">
                    <i class="bi bi-x-lg"></i>
                </button>
                <button id="submit-feedback-btn" class="modal-action-btn" title="送出回饋" aria-label="送出回饋">
                    <i class="bi bi-send"></i>
                </button>
            `;
            actionsContainer.setAttribute('aria-hidden', 'false');

            // 綁定「送出」按鈕的事件
            document.getElementById('submit-feedback-btn').addEventListener('click', () => {
                submitFeedback();
            });
        });

        // 當 feedbackModal 隱藏時清空外部按鈕容器，避免殘留事件綁定
        feedbackModalEl.addEventListener('hidden.bs.modal', function () {
            const actions = document.getElementById('feedbackModalActions');
            if (actions) {
                actions.innerHTML = '';
                actions.setAttribute('aria-hidden', 'true');
            }
        });

        // CSRF helper
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>
    {% block extra_js %}{% endblock %}
</body>
</html>
